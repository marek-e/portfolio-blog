---
import Layout from '@/layouts/Layout.astro';
import Navbar from '@/components/astro/Navbar.astro';
import Footer from '@/components/astro/Footer.astro';
import { Badge } from '@/components/ui/badge';
import {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from '@/components/ui/breadcrumb';
import { Link } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';
import { getCollection, render } from 'astro:content';
import { getTranslations, defaultLang } from '@/i18n';
import { getTranslatedPath } from '@/i18n/config';
import { mdxComponents } from '@/components/mdx';
import { Icon } from '@/components/react/Icon';
import {
  ArrowLeft02Icon,
  HomeIcon,
  Globe02Icon,
  SourceCodeIcon,
  UserIcon,
  TimeQuarterIcon,
  UserMultiple02Icon,
  CheckmarkCircle02Icon,
  Bulb,
} from '@hugeicons/core-free-icons';
import { Image } from 'astro:assets';
import { getTechColor, getStatusVariant, formatProjectDate } from '@/lib/projects';
import { getProjectImage, getProjectImageSafe } from '@/lib/images';

type Project = Awaited<ReturnType<typeof getCollection<'projects'>>>[number];

type StaticPaths = {
  params: { lang: 'en' | undefined; slug: string };
  props: { project: Project };
};

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  const staticPaths: StaticPaths[] = [];

  projects.forEach((project) => {
    const [lang, ...slugParts] = project.id.split('/');
    const slug = slugParts.join('/').replace(/\.(md|mdx)$/, '');

    if (lang === 'en') {
      staticPaths.push({ params: { lang: 'en', slug }, props: { project } });
    } else {
      staticPaths.push({ params: { lang: undefined, slug }, props: { project } });
    }
  });

  return staticPaths;
}

const { project } = Astro.props;
const lang = Astro.params.lang ?? defaultLang;
const t = getTranslations(lang);
const translatePath = getTranslatedPath(lang);

const projectImage = getProjectImage(project.data.image);

const { Content } = await render(project);
const {
  title,
  description,
  techStack,
  role,
  links,
  image,
  imageAlt,
  objectFit,
  publishDate,
  status = 'completed',
  duration,
  team,
  highlights,
  lessons,
  gallery,
} = project.data;

const statusKey = `status${status.charAt(0).toUpperCase()}${status.slice(1).replace('-', '')}` as
  | 'statusCompleted'
  | 'statusInprogress'
  | 'statusArchived'
  | 'statusConcept';

// Prepare gallery images with optimized sources
const galleryImages = gallery?.map((item) => ({
  ...item,
  image: getProjectImageSafe(item.src),
}));
---

<Layout title={`${title} | ${t.projectsPage.title}`} description={description}>
  <script
    is:inline
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'CreativeWork',
      name: title,
      description: description,
      author: {
        '@type': 'Person',
        name: 'Marek Elmayan',
        url: 'https://melmayan.fr',
      },
      datePublished: publishDate.toISOString(),
      url: Astro.url.href,
      inLanguage: lang,
      keywords: techStack.join(', '),
      ...(image && { image: new URL(image, Astro.site).toString() }),
      ...(links?.demo && { url: links.demo }),
      ...(links?.repo && { codeRepository: links.repo }),
    })}
  />
  <Navbar />
  <main class="container mx-auto max-w-5xl px-4 pt-32 pb-8">
    <Breadcrumb className="mb-10">
      <BreadcrumbList>
        <BreadcrumbItem>
          <BreadcrumbLink href={translatePath('/')}>
            <Icon
              icon={HomeIcon}
              strokeWidth={2}
              className="motion-safe:hover:animate-wiggle size-4 transition-transform duration-300 ease-in-out"
            />
          </BreadcrumbLink>
        </BreadcrumbItem>
        <BreadcrumbSeparator />
        <BreadcrumbItem>
          <BreadcrumbLink href={translatePath('/projects')}>
            {t.nav.projects}
          </BreadcrumbLink>
        </BreadcrumbItem>
        <BreadcrumbSeparator />
        <BreadcrumbItem>
          <BreadcrumbPage>{title}</BreadcrumbPage>
        </BreadcrumbItem>
      </BreadcrumbList>
    </Breadcrumb>

    <article>
      <header class="mb-6 space-y-6">
        <div class="text-muted-foreground flex flex-wrap items-center gap-4 text-sm">
          <Badge variant={getStatusVariant(status)}>
            {t.projectsPage[statusKey]}
          </Badge>
          <time datetime={publishDate.toISOString()}>
            {formatProjectDate(publishDate, lang)}
          </time>
        </div>

        <h1 class="text-4xl font-bold tracking-tight lg:text-5xl">
          <span class="text-primary">{title}</span>
        </h1>

        <p class="text-muted-foreground max-w-3xl text-lg">{description}</p>

        {
          (links?.demo || links?.repo) && (
            <div class="flex flex-wrap gap-3">
              {links.demo && (
                <Link href={links.demo} target="_blank" rel="noopener noreferrer" variant="default">
                  <Icon icon={Globe02Icon} strokeWidth={2} className="size-4" />
                  {t.projectsPage.viewLive}
                </Link>
              )}
              {links.repo && (
                <Link href={links.repo} target="_blank" rel="noopener noreferrer" variant="outline">
                  <Icon icon={SourceCodeIcon} strokeWidth={2} className="size-4" />
                  {t.projectsPage.viewCode}
                </Link>
              )}
            </div>
          )
        }
      </header>
      <div class="bg-primary mb-6 h-0.5 w-10 rounded-full"></div>

      {
        image && (
          <div class="mb-10 flex items-center">
            <div class="bg-muted border-border h-60 overflow-hidden rounded-xl border">
              <Image
                src={projectImage}
                fetchpriority="low"
                loading="lazy"
                alt={imageAlt || `Screenshot of ${title}`}
                class="h-full w-full object-cover"
                style={{ objectFit }}
              />
            </div>
          </div>
        )
      }

      <div class="ring-foreground/10 mb-10 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        {
          role && (
            <div class="bg-card rounded-lg p-4 ring-1 ring-inherit">
              <div class="text-muted-foreground mb-1 flex items-center gap-2 text-sm">
                <Icon icon={UserIcon} strokeWidth={2} className="size-4" />
                {t.projectsPage.role}
              </div>
              <p class="font-medium">{role}</p>
            </div>
          )
        }

        {
          duration && (
            <div class="bg-card rounded-lg p-4 ring-1 ring-inherit">
              <div class="text-muted-foreground mb-1 flex items-center gap-2 text-sm">
                <Icon icon={TimeQuarterIcon} strokeWidth={2} className="size-4" />
                {t.projectsPage.duration}
              </div>
              <p class="font-medium">{duration}</p>
            </div>
          )
        }

        {
          team && (
            <div class="bg-card rounded-lg p-4 ring-1 ring-inherit">
              <div class="text-muted-foreground mb-1 flex items-center gap-2 text-sm">
                <Icon icon={UserMultiple02Icon} strokeWidth={2} className="size-4" />
                {t.projectsPage.team}
              </div>
              <p class="font-medium">{team}</p>
            </div>
          )
        }
      </div>

      <section class="mb-10">
        <h2 class="mb-4 text-lg font-semibold">{t.projectsPage.techStack}</h2>
        <div class="flex flex-wrap gap-2">
          {techStack.map((tech) => <Badge variant={getTechColor(tech)}>{tech}</Badge>)}
        </div>
      </section>

      {
        highlights && highlights.length > 0 && (
          <section class="bg-primary/5 mb-10 rounded-xl p-6">
            <h2 class="mb-4 flex items-center gap-2 text-lg font-semibold">
              <Icon icon={CheckmarkCircle02Icon} strokeWidth={2} className="text-primary size-5" />
              {t.projectsPage.highlights}
            </h2>
            <ul class="space-y-2">
              {highlights.map((highlight) => (
                <li class="flex items-start gap-3">
                  <span class="text-primary mt-1.5">•</span>
                  <span>{highlight}</span>
                </li>
              ))}
            </ul>
          </section>
        )
      }

      <Separator className="my-8" />

      <div class="prose prose-neutral dark:prose-invert max-w-none">
        <Content components={mdxComponents} />
      </div>

      {
        lessons && lessons.length > 0 && (
          <>
            <Separator className="my-8" />
            <section class="rounded-xl bg-amber-50 p-6 dark:bg-amber-950/20">
              <h2 class="mb-4 flex items-center gap-2 text-lg font-semibold">
                <Icon
                  icon={Bulb}
                  strokeWidth={2}
                  className="size-5 text-amber-600 dark:text-amber-400"
                />
                {t.projectsPage.lessons}
              </h2>
              <ul class="space-y-2">
                {lessons.map((lesson) => (
                  <li class="flex items-start gap-3">
                    <span class="mt-1.5 text-amber-600 dark:text-amber-400">•</span>
                    <span>{lesson}</span>
                  </li>
                ))}
              </ul>
            </section>
          </>
        )
      }

      {
        galleryImages && galleryImages.length > 0 && (
          <>
            <Separator className="my-8" />
            <section>
              <h2 class="mb-6 text-lg font-semibold">{t.projectsPage.gallery}</h2>
              <div class="grid gap-4 sm:grid-cols-2">
                {galleryImages.map((item) =>
                  item.image ? (
                    <figure class="bg-muted overflow-hidden rounded-lg">
                      <Image
                        src={item.image}
                        alt={item.alt}
                        class="aspect-video w-full object-cover"
                        loading="lazy"
                      />
                      {item.caption && (
                        <figcaption class="text-muted-foreground p-3 text-center text-sm">
                          {item.caption}
                        </figcaption>
                      )}
                    </figure>
                  ) : null
                )}
              </div>
            </section>
          </>
        )
      }

      <hr class="border-border my-8" />

      <Link href={translatePath('/projects')} variant="link">
        <Icon icon={ArrowLeft02Icon} strokeWidth={2} className="size-4" />
        {t.projectsPage.backToProjects}
      </Link>
    </article>
  </main>
</Layout>
<Footer />

<script>
  import { initCopyButtons } from '@/lib/copy-buttons';

  initCopyButtons();
  document.addEventListener('astro:after-swap', initCopyButtons);
</script>
