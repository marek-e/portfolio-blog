---
import Layout from '@/layouts/Layout.astro';
import Navbar from '@/components/astro/Navbar.astro';
import Footer from '@/components/astro/Footer.astro';
import { Badge } from '@/components/ui/badge';
import { getCollection } from 'astro:content';
import { getTranslations, defaultLang } from '@/i18n';
import { getTranslatedPath, languages } from '@/i18n/config';
import { ArrowRight02Icon } from '@hugeicons/core-free-icons';
import { Icon } from '@/components/react/Icon';
import { formatDate, getSlug, estimateReadingTime, getTagColor } from '@/lib/blog';

export function getStaticPaths() {
  return [{ params: { lang: undefined } }, { params: { lang: 'en' } as const }];
}

const lang = Astro.params.lang ?? defaultLang;
const t = getTranslations(lang);
const translatePath = getTranslatedPath(lang);

const allPosts = await getCollection('blog');
const posts = allPosts
  .filter((post) => post.id.startsWith(`${lang}/`))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());
---

<Layout title={t.blog.pageTitle} description={t.blog.pageDescription}>
  <script
    is:inline
    slot="head"
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'Blog',
      name: 'Blog - Marek Elmayan',
      url: 'https://melmayan.fr/blog',
      description: "Articles sur le développement web, l'UX, la cybersécurité et l'IA.",
      author: {
        '@type': 'Person',
        name: 'Marek Elmayan',
      },
      inLanguage: Object.keys(languages),
    })}
  />
  <Navbar />
  <main class="container mx-auto min-h-dvh w-full max-w-5xl px-4 pt-32 pb-16">
    <header class="mb-12 space-y-4">
      <h1 class="text-4xl font-bold tracking-tight">{t.blog.title}</h1>
      <p class="text-foreground text-lg">{t.blog.subtitle}</p>
    </header>

    {
      posts.length === 0 ? (
        <p class="text-muted-foreground py-12 text-center">{t.blog.noPosts}</p>
      ) : (
        <ul class="space-y-8">
          {posts.map((post) => (
            <li>
              <a
                href={translatePath(`/blog/${getSlug(post.id, lang)}`)}
                class="group border-border bg-card hover:border-primary/50 hover:bg-card/80 block rounded-lg border p-6 transition-colors"
              >
                <article class="space-y-3">
                  <div class="text-muted-foreground flex flex-wrap items-center justify-between gap-2 text-sm">
                    <div class="flex items-center gap-16">
                      <time datetime={post.data.publishDate.toISOString()}>
                        {formatDate(post.data.publishDate, lang)}
                      </time>
                      <span>
                        {post.body && estimateReadingTime(post.body)} {t.blog.minRead}
                      </span>
                    </div>
                    {post.data.tags.length > 0 && (
                      <div class="flex flex-wrap gap-1.5">
                        {post.data.tags.map((tag) => (
                          <Badge variant={getTagColor(tag)} className="text-xs">
                            {tag}
                          </Badge>
                        ))}
                      </div>
                    )}
                  </div>
                  <h2 class="text-xl font-semibold transition-colors">{post.data.title}</h2>
                  <p class="text-muted-foreground line-clamp-2">{post.data.description}</p>
                  <span class="text-primary group-hover:bg-primary/10 inline-flex items-center gap-2 rounded-md px-3 py-1.5 text-sm font-medium transition-all group-hover:gap-3">
                    {t.blog.readMore}
                    <Icon icon={ArrowRight02Icon} strokeWidth={2} className="size-4" />
                  </span>
                </article>
              </a>
            </li>
          ))}
        </ul>
      )
    }
  </main>
  <Footer />
</Layout>
