---
import { processFileTree } from '@/lib/rehype-file-tree';

const fileTreeHtml = await Astro.slots.render('default');
const html = processFileTree(fileTreeHtml, 'Directory');
---

<file-tree set:html={html} class="not-prose" data-pagefind-ignore />

<script>
	function setupFileTreeAnimations() {
		const DURATION = 150;

		document
			.querySelectorAll<HTMLDetailsElement>('file-tree .directory > details')
			.forEach((details) => {
				const summary = details.querySelector<HTMLElement>(':scope > summary');
				if (!summary) return;

				summary.addEventListener('click', (e) => {
					e.preventDefault();
					const content = details.querySelector<HTMLElement>(':scope > ul');
					if (!content || content.getAnimations().length > 0) return;

					if (details.open) {
						const h = content.offsetHeight;
						content.style.overflow = 'hidden';
						const anim = content.animate(
							{ height: [`${h}px`, '0px'], opacity: [1, 0] },
							{ duration: DURATION, easing: 'ease-in' },
						);
						anim.onfinish = () => {
							details.open = false;
							content.style.overflow = '';
						};
					} else {
						details.open = true;
						const h = content.offsetHeight;
						content.style.overflow = 'hidden';
						content.animate(
							{ height: ['0px', `${h}px`], opacity: [0, 1] },
							{ duration: DURATION, easing: 'ease-out' },
						);
						setTimeout(() => (content.style.overflow = ''), DURATION);
					}
				});
			});
	}

	setupFileTreeAnimations();
</script>

<style>
	file-tree {
		--x-space: 1.5rem;
		--y-space: 0.125rem;
		--y-pad: 0;

		display: block;
		border: 1px solid var(--color-border);
		padding: 1rem;
		background-color: var(--color-card);
		font-size: 0.875rem;
		font-family: var(--font-sans);
		overflow-x: auto;
		border-radius: var(--radius-lg);
		margin: 1.5rem 0;
	}

	file-tree :global(.directory > details) {
		border: 0;
		padding: 0;
		padding-inline-start: var(--x-space);
		background: transparent;
	}

	file-tree :global(.directory > details > summary) {
		margin-inline-start: calc(-1 * var(--x-space));
		border: 0;
		padding: var(--y-pad) 0.625rem;
		font-weight: normal;
		color: var(--color-foreground);
		max-width: 100%;
		cursor: pointer;
		list-style: none;
	}

	file-tree :global(.directory > details > summary::-webkit-details-marker) {
		display: none;
	}

	file-tree :global(.directory > details > summary::marker) {
		display: none;
	}

	file-tree :global(.directory > details > summary:hover),
	file-tree :global(.directory > details > summary:hover .tree-icon) {
		color: var(--color-primary);
		fill: currentColor;
	}

	file-tree :global(.directory > details > summary:hover ~ ul) {
		border-color: var(--color-border);
	}

	file-tree :global(.directory > details > summary:hover .highlight .tree-icon) {
		color: var(--color-primary-foreground);
		fill: currentColor;
	}

	file-tree :global(ul) {
		margin-inline-start: 0.5rem;
		border-inline-start: 1px solid var(--color-border);
		padding: 0;
		padding-inline-start: 0.125rem;
		list-style: none;
	}

	file-tree > :global(ul) {
		margin: 0;
		border: 0;
		padding: 0;
	}

	file-tree :global(li) {
		margin: var(--y-space) 0;
		padding: var(--y-pad) 0;
	}

	file-tree :global(.file) {
		margin-inline-start: calc(var(--x-space) - 0.125rem);
		color: var(--color-foreground);
	}

	file-tree :global(.tree-entry) {
		display: inline-flex;
		align-items: flex-start;
		flex-wrap: wrap;
		max-width: calc(100% - 1rem);
	}

	@media (min-width: 30em) {
		file-tree :global(.tree-entry) {
			flex-wrap: nowrap;
		}
	}

	file-tree :global(.tree-entry > :first-child) {
		flex-shrink: 0;
	}

	file-tree :global(.empty) {
		color: var(--color-muted-foreground);
		padding-inline-start: 0.375rem;
	}

	file-tree :global(.comment) {
		color: var(--color-muted-foreground);
		padding-inline-start: 1.625rem;
		max-width: 24rem;
		min-width: 12rem;
	}

	file-tree :global(.highlight) {
		display: inline-block;
		border-radius: 0.25rem;
		padding-inline-end: 0.5rem;
		color: var(--color-primary-foreground);
		background-color: var(--color-primary);
	}

	file-tree :global(svg) {
		display: inline;
		fill: var(--color-muted-foreground);
		vertical-align: middle;
		margin-inline: 0.25rem 0.375rem;
		width: 0.875rem;
		height: 0.875rem;
	}

	file-tree :global(.highlight svg.tree-icon) {
		fill: currentColor;
	}

	file-tree :global(.sr-only) {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border-width: 0;
	}
</style>
