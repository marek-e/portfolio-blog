---
import { getCollection } from 'astro:content';
import { FeaturedProjectsCarousel } from '@/components/react/FeaturedProjectsCarousel';
import { getTranslations, getLangFromUrl, getTranslatedPath } from '@/i18n';

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);
const translatePath = getTranslatedPath(lang);

const allProjects = await getCollection('projects');
const featuredProjects = allProjects
  .filter((project) => project.id.startsWith(`${lang}/`))
  .filter((project) => project.data.featured)
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf())
  .slice(0, 5);

// Serialize projects for React component
const serializedProjects = featuredProjects.map((project) => ({
  data: {
    title: project.data.title,
    description: project.data.description,
    techStack: project.data.techStack,
    links: project.data.links,
    image: project.data.image,
    imageAlt: project.data.imageAlt,
    objectFit: project.data.objectFit,
  },
  slug: project.id.replace(/^(fr|en)\//, ''),
}));

const carouselTranslations = {
  liveDemo: t.projects.liveDemo,
  code: t.projects.code,
  viewDetails: t.projects.viewDetails,
};
---

<section id="projects" class="relative py-20 md:py-32">
  <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
    <div class="mb-6 flex items-end justify-between md:mb-12">
      <div>
        <h2 class="text-foreground text-3xl font-bold tracking-tight md:text-4xl">
          {t.projects.title}
        </h2>
        <p class="text-muted-foreground mt-2">{t.projects.subtitle}</p>
      </div>
      <a
        href={translatePath('/projects')}
        class="text-primary hover:text-primary/80 text-md hidden font-semibold transition-colors md:block"
      >
        {t.projects.viewAll}
      </a>
    </div>

    {
      featuredProjects.length > 0 ? (
        <div class="md:px-12">
          <FeaturedProjectsCarousel
            client:visible
            projects={serializedProjects}
            translations={carouselTranslations}
            lang={lang}
          />
        </div>
      ) : (
        <p class="text-muted-foreground">{t.projects.noProjects}</p>
      )
    }

    <div class="mt-8 text-center md:hidden">
      <a
        href={translatePath('/projects')}
        class="text-primary hover:text-primary/80 text-sm font-medium transition-colors"
      >
        {t.projects.viewAll}
      </a>
    </div>
  </div>
</section>
