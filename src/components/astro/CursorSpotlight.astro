---
interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
---

<div class:list={['cursor-spotlight-wrapper', className]} data-spotlight>
  <slot />
</div>

<style>
  .cursor-spotlight-wrapper {
    position: relative;
  }

  .cursor-spotlight-wrapper::before {
    content: '';
    position: fixed;
    width: 600px;
    height: 600px;
    border-radius: 50%;
    background: radial-gradient(
      circle,
      oklch(from var(--primary) l c h / 0.15) 0%,
      oklch(from var(--primary) l c h / 0.08) 25%,
      oklch(from var(--primary) l c h / 0.02) 50%,
      transparent 70%
    );
    transform: translate(-50%, -50%);
    left: var(--spotlight-x, -1000px);
    top: var(--spotlight-y, -1000px);
    pointer-events: none;
    z-index: 1;
    opacity: 0;
    transition: opacity 0.3s ease-out;
    will-change: left, top;
  }

  .cursor-spotlight-wrapper[data-spotlight-active]::before {
    opacity: 1;
  }

  @media (prefers-reduced-motion: reduce) {
    .cursor-spotlight-wrapper::before {
      display: none;
    }
  }

  @media (pointer: coarse) {
    .cursor-spotlight-wrapper::before {
      display: none;
    }
  }
</style>

<script>
  function initCursorSpotlight() {
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      return;
    }

    if (window.matchMedia('(pointer: coarse)').matches) {
      return;
    }

    const wrappers = document.querySelectorAll<HTMLElement>('[data-spotlight]');

    wrappers.forEach((wrapper) => {
      let rafId: number | null = null;

      const updatePosition = (x: number, y: number) => {
        if (rafId) {
          cancelAnimationFrame(rafId);
        }

        rafId = requestAnimationFrame(() => {
          wrapper.style.setProperty('--spotlight-x', `${x}px`);
          wrapper.style.setProperty('--spotlight-y', `${y}px`);
        });
      };

      wrapper.addEventListener('mouseenter', () => {
        wrapper.setAttribute('data-spotlight-active', '');
      });

      wrapper.addEventListener('mouseleave', () => {
        wrapper.removeAttribute('data-spotlight-active');
      });

      wrapper.addEventListener('mousemove', (e: MouseEvent) => {
        updatePosition(e.clientX, e.clientY);
      });
    });
  }

  initCursorSpotlight();

  document.addEventListener('astro:after-swap', initCursorSpotlight);
</script>
